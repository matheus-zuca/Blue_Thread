<!DOCTYPE html>
<html lang='fr'>
<head>
    <title>Blue Thread</title> 
    <meta charset=utf-8>
    <link href="/static/style.css" rel="stylesheet" type="text/css" />
</head>
<body onload="resizePosts()">

    <div class="fond">
    <h1>Blue Thread <span id="version">v0.1.1</span></h1>
    
    {% with messages = get_flashed_messages()%}
        {% if messages%}
            {% for message in messages%}
            <p class="flash_error"><strong>{{message}}</strong></p>
            {%endfor%}
        {%endif%}
    {%endwith%}
    <p>Connecté en tant que {{session.name}} <a href="/logout"><button id="btn_logout" class="btn">Déconnexion</button></a></p>
    
    <form method="POST" id="form_text">
        <textarea id="ta_text" name="text" rows="30" cols="70" minlength="300" autocomplete="off" autocorrect="on"  autofocus="on" placeholder="Racontez-nous tout">{{text}}</textarea>
        <input id="btn_cut" type="Submit" name="action" value="Découper le texte" class="btn" {% if text == "" %} disabled {% endif %} />
    </form>
    
    <form method="POST" id="form_posts" enctype="multipart/form-data" >
        <div id="div_posts">
        {% for post in thread %}
            <div id="div_post{{loop.index}}" class="div_post">
                <textarea id="ta_post{{loop.index}}" name="post" class="ta_post" maxlength="300" oninput="resizeTextarea(this)">{{post}}</textarea>
                <!-- <label for="input_images{{loop.index}}"><img src="static/image_icon.png" /></label> -->
                <input id="input_images{{loop.index}}" type="file" name="input_images" accept="image/png, image/jpg, image/jpeg" class="input_images"  onchange="loadFile(event, {{loop.index}})"/>
                <div id="nb_char{{loop.index}}" class="nb_char"><span>0</span>/300</div>
                <output id="thumbnail_zone{{loop.index}}"><table><tr id="output_table_row{{loop.index}}"></tr></table></output>
            </div>
        {%endfor%}
        {% if thread | length%}
        <button type="button" id="btn_remove_post" title="Supprimer un post" onclick="removePost(this)">-</button>
        <button type="button" id="btn_add_post" title="Ajouter un post" onclick="addPost(this)">+</button>
        <input id="btn_send" type="Submit" name="action" value="Envoyer" {{disabled}}class="btn" />
        {% endif %}
        </div>
    </form>
    </div>
    
    <script>
    const btn_cut = document.getElementById("btn_cut");
    const ta_text = document.getElementById("ta_text");
    // Only allow to click on the cut button if the text is long enough
    ta_text.addEventListener('input', () => {
        btn_cut.disabled = ta_text.value.length < 300;
    });
    
    /* Displays a dialog to ask the alt text and updates the input value */
    var inputAlt = function (event){
        // console.log(event);
        const input = event.target;
        const old_alt_text = document.getElementById(input.id).value;  // get the previous alt value which is in the input field
        new_alt_text = prompt("Décrivez l'image :", old_alt_text);      // Prompts the user to input a new alt text
        document.getElementById(input.id).value=new_alt_text;          // Sets the input value with the new alt text
        document.getElementById(input.previousElementSibling.firstChild.id).title=new_alt_text;    // Sets the img title property which displays a tooltip over the picture
    };
    
    /* Called when a picture is added 
       It adds the picture's thumbnail, and an input field for the alt text */
    var loadFile = function(event, i) {
        const tr = document.getElementById('output_table_row'+i);
        const num_image = tr.cells.length+1;
                
        const image=document.createElement("img");
        image.src = URL.createObjectURL(event.target.files[0]);
        image.id="img"+i+"_"+num_image;
        
        // Link that opens the picture in a new tab
        const lien=document.createElement("a");
        lien.href=URL.createObjectURL(event.target.files[0]);
        lien.target="_blank"
        lien.appendChild(image);
        
        const alt=document.createElement("input");
        alt.placeholder="alt";
        alt.id="alt"+i+"_"+num_image;
        alt.name="alt"+i
        alt.addEventListener("click", inputAlt);
        
        const td=document.createElement("td");
        td.appendChild(lien);
        td.appendChild(alt);
        
        tr.appendChild(td);        
        
    };
    
    /* Resizes a textarea to matchy the content height */
    function resizeTextarea(element){
        element.style.height = "auto";
        element.style.height = element.scrollHeight-10 + "px";
        
        /* Updating the displayed number of characters */
        var nb_char = element.value.length;
        const span_nb_char = element.parentNode.getElementsByClassName("nb_char")[0].firstChild;
        span_nb_char.innerText = nb_char;
        
        if (nb_char >= 290) {
            span_nb_char.classList.add("warning");
        }
        else{
            span_nb_char.classList.remove("warning");
        }
        
        const btn_send = document.getElementById("btn_send");
        
        if (element.value == ""){
            btn_send.disabled = true;
            btn_send.title="Aucun post ne doit être vide pour envoyer le thread";
        }
        else {
           btn_send.disabled = false;
           btn_send.title="";
        }
        
    }
    
    /* Resizes all the posts textareas */
    function resizePosts(){
        var ta = document.getElementById('form_posts').getElementsByTagName('textarea');
        var i = 1;
        for (let element of ta) {
          resizeTextarea(element);
          i=i+1;
        }
    }
    
    /* Adds a new post at the botom of the posts */
    function addPost(element){
        /* Copy of the first div_post */
        const new_div = document.getElementById("div_post1").cloneNode(true);
        const new_ta = new_div.getElementsByClassName("ta_post").post
      //  const new_label = new_div.getElementsByTagName("label").label
        const new_input = new_div.getElementsByClassName("input_images").input_images
        const new_nb_char = new_div.getElementsByClassName("nb_char").nb_char1
        const new_thumbnail_zone = new_div.getElementsByTagName("output").thumbnail_zone1
        const new_number = document.getElementsByClassName("div_post").length+1;
        
        new_div.id="div_post"+new_number;
        
        new_ta.id = "ta_post"+new_number;
        new_ta.innerText="";
        
        new_input.id="input_images"+new_number;
        
        new_nb_char.id="nb_char"+new_number;
        new_nb_char.firstChild.innerText="0";
                
        new_thumbnail_zone.id="thumbnail_zone"+new_number;
        new_thumbnail_zone.getElementsByTagName("tr").output_table_row1.innerHTML = "";
        new_thumbnail_zone.getElementsByTagName("tr").output_table_row1.id="output_table_row"+new_number;
        
        element.parentNode.insertBefore(new_div, document.getElementById("btn_remove_post"));
 
        resizeTextarea(new_ta);
        
        /* If there is only 2 posts (we just added one so there was only one before), we activate the remove button again */
        if (document.getElementsByClassName("div_post").length == 2){
            document.getElementById("btn_remove_post").hidden = false;
            document.getElementById("btn_add_post").style.marginLeft = "15px";
        }
    }
    
    /* Removes the last post of the thread */
    function removePost(element){
    
        /* Deletes the previous post */
        element.previousElementSibling.remove();
        
        /* If there is only one post left, we hide the "remove post" button */
        if (document.getElementsByClassName("div_post").length == 1){
            element.hidden = true;
            document.getElementById("btn_add_post").style.marginLeft = "0px";
        }
        
        resizePosts();
    }
    
    </script>

</body>
<html>